# Установка и запуск приложения на удаленном сервере

## Требования к предварительному наличию ПО на сервере
Минимально необходимо иметь docker и git. Также при необходимости можно иметь системный сервер nginx, 
который настраивается как прокси для сервера приложения uvicorn. 
## Скачивание исходного кода проекта
Склонируйте проект при помощи git
```shell
cd ~/hosted_apps/
git clone https://github.com/Gevorji/currency-exchange-fapi.git
```

## Файл переменных окружения

Файл должен располагаться в корневой директории приложения и содержать следующие переменные:  

`DEBUG` - контроль дебаг-режима. В дебаг-режиме будут выводиться логи приложения уровня DEBUG, а также логи SQL запросов 
приложения к БД.  
`AUTH_JWT_PUB_KEY_PATH` - путь к файлу открытого ключа, применяемого для проверки хэша jwt-токенов авторизации.  
`AUTH_JWT_PRIV_KEY_PATH` - путь к файлу закрытого ключа, применяемого для вычисления хэша jwt-токенов авторизации.  

`DB_HOST` - адрес хоста базы данных.
`DB_PORT` - номер порта на хосте базе данных.  
`DB_USERNAME` - имя пользователя для подключения к БД.  
`DB_PASSWORD` - пароль пользователя БД.  
`DB_DB_NAME` - имя БД для подключения.  

`POSTGRES_USER` - имя пользователя, который будет создан в Postgresql при запуске контейнера
`POSTGRES_PASSWORD` - пароль пользователя, который будет создан в Postgresql при запуске контейнера

`APP_LOG_LEVEL` - уровень логгирования в приложении ("DEBUG", "INFO", "WARNING", "ERROR", "CRITICAL"). 
По умолчанию установлено значение "INFO". В дебаг режиме значение уровня всегда DEBUG, вне
зависимости от значения данной переменной.

### [Переменные окружения для телеграмм-бота](https://github.com/Gevorji/currency-exchange-tg-bot?tab=readme-ov-file#%D0%BF%D0%B5%D1%80%D0%B5%D0%BC%D0%B5%D0%BD%D0%BD%D1%8B%D0%B5-%D0%BE%D0%BA%D1%80%D1%83%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F-%D0%B2-%D1%84%D0%B0%D0%B9%D0%BB%D0%B5-env)

Дополнительная конфигурация приложений может быть осуществлена через переменные в модулях config.py. Там же приведены
разъяснения касательно того, за что отвечают переменные.

## Телеграм-бот
Необходимо склонировать код приложения из репозитория:
```shell 
git clone https://github.com/Gevorji/currency-exchange-tg-bot ~/hosted_apps/
```
### Регистрация приложения-клиента в сервисе
Необходимо зарегистрировать приложение бота в сервисе путем обращения к предназначенному для этого
эндпойнта. Приложение бота затем само будет поддерживать токены доступа в актуальном состоянии, имея
имя пользователя и пароль от своей клиентской учетной записи в сервисе.  
Для ручного управления токенами реализованы команды '/revoketokens' и '/expungetokens', доступные
только админ-пользователям в чате с ботом.
### Перед сборкой контейнеров
Создать файл admin_records в рабочей директории. Файл имеет текстовое содержание, формат - id чатов администраторов, 
разделенные запятой (например `123452,242343,145432`). Наличие хотя бы пустого файла требуемо.
id личного чата с ботом выводится вместе с приветственным сообщением на команду `/start`.  
Разместить файл `.tgbot.env` с переменными окружения для приложения бота в текушей директории, откуда будем запускать
`docker compose`.  
Установить переменную окружения `CUREXCH_TG_BOT_DIR_PTH`, которая указывает на директорию

## Ключи для подписи и верификации jwt-токенов
Приложению потребуется ключ RSA для работы с jwt-токенами пользователей.  
Сгенерируйте ключи в рабочую директорию (учесть, что в окружении нужно иметь установленную либу joserfc):
```shell 
python src/currency_exchange/utils/genkeys.py --pub ./jwt_secret.pub --priv ./jwt_secret
```
*\*Если в команде меняете названия файлов с ключами, то следует поменять соответствующие переменные, указывающие 
приложению путь к этим файлам в config.py, секция `AuthConfig`*

## Запуск docker-контейнеров
Убедитесь, что вы в корневой директории приложения:
```shell
cd ~/hosted_apps/currency-exchange-fapi
```
Убедитесь, что в корневой директории приложения присутствуют файлы переменных окружения
[.env](#файл-переменных-окружения-env) и `.tgbot.env` с валидным содержимым, а также файл admin_records.
### Без контейнера nginx
В этом случае будут запущены только контейнеры базы данных и приложения. Контейнер приложения будет привязан к внешнему
порту __8000__ на адресе __127.0.0.1__.

Предусмотрена возможность изменения внешнего порта и адреса контейнера приложения через переменную окружения 
CUREXCH_SERVER_ADDR_BIND. Корректные значения для переменной такие же, как для HOSTS в 
[синтаксисе](https://docs.docker.com/reference/compose-file/services/#short-syntax-3) 
значения ключа ports файла docker-compose. Переменная окружения должна быть установлена до запуска контейнеров:
```shell
export CUREXCH_SERVER_ADDR_BIND=your_value
```
При включении в группу контейнров приложения тг-бота, установите переменную директории с его кодом:  
```shell
export CUREXCH_TG_BOT_DIR_PTH=your_value
```

Контейнеры запускаются командой\*:
```shell
docker compose -f docker/docker-compose.prod.yml up -d
```
Останавливаются командой\*:
```shell
docker compose -f docker/docker-compose.prod.yml down
```

*\* Сборка предусмотрена "послойной", т. е. добавление сервисов происходит за счет указания в 
параметрах `docker compose` дополнительных compose-файлов*

Запуск со всеми предусмотренными сервисами (сервис обмена валют, БД, прокси-веб-сервера для сервиса и фронтенд-бот):
```shell
docker compose -f docker/docker-compose.prod.yaml -f docker/docker-compose.front-tgbot.yaml \
-f docker/nginx/docker-compose.nginx.opt.prod.yml up -d
```

## Удаление просроченных токенов пользователей из БД
Рекомендуется периодически чистить базу данных от просроченных токенов доступа:
```shell
docker compose -f docker/docker-compose.prod.yml exec currency_exchange_service clearexptokens
```
Можно настроить планировщик задач cron, имеющийся в Linux дистрибутиве, чтобы делать это на регулярной основе:
```shell
crontab -e
# следующую строку вставить в открывшемся текстовом редакторе
@weekly docker compose -f docker/docker-compose.prod.yml exec currency_exchange_service clearexptokens
```

## Инициализация схем базы данных (выполнение миграций)
Для поддержки миграций схем данных в БД используется alembic. Подключившись к процессу терминала в контейнере сервиса,
выполнить команду `alembic upgrade head`.

##  Переменные окружения, влияющие на запуск docker контейнеров
`CUREXCH_SERVER_ADDR_BIND` *(опционально)* - адрес и порт, на котором будет слушать сервер приложения (uvicorn). 
Стандартное значение `127.0.0.1:8000`.

`CUREXCH_TG_BOT_DIR_PTH` *(обязательно, если добавляется compose файл приложения тг-бота)* - 
путь к директории проекта телергамм-бота (например '/home/gevorji/Desktop/currency-exchange-tg-bot')

`NGINX_LISTEN_PORT` *(опционально, влияет только при добавлении compose файла для прокси-сервера)* - 
порт, на котором будет слушать прокси-сервер приложения nginx. Стандартное значение `8000`.